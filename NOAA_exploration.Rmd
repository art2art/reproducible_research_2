```{r setup, include = FALSE}
require(plyr)
require(ggplot2)
opts_chunk$set(message = FALSE)
```

Exploration of the NOAA Storm Database and types of the most harmful meteorological events
========================================================================================

## Synopsis

The target of this analysis is to find out which metereological events cause the most harmful effects for human health and have the greatest economic consequences in terms of property damage. For the research of given objectives the U.S. National Oceanic and Atmospheric Administration's storm database from the past 60 years was used. It turned out that tornado was the most harmful metereological event which caused over 90000 injuries in the last 60 years and floods had the greatest economic consequences with over 150 billion dollars in property damages.

## Data Processing

### Loading data

The data got downloaded from [source](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2) and stored as `stormData.csv` file at the disk in the current working directory.

```{r}
data.url <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
file.csv <- "stormData.csv"

if (!exists("storm") & file.exists(file.csv))
    storm <- read.csv(file.csv, na.strings = "")
    
if (!file.exists(file.csv)) {
    file.tmp <- tempfile()
    
    download.file(data.url, destfile = file.tmp, method = "curl")
    conn <- bzfile(file.tmp)
    
    storm <- read.csv(conn, na.strings = "")
    write.csv(storm, file = file.csv)
    
    close(conn)
    file.remove(file.tmp)
}
```

The dataframe `storm` contains the 902,297 observation of 37 variables.
```{r}
dim(storm)
```

### Preprocessing

Pull out the necessary variables for estimating the harmful effect and economic consequences of the events included in the NOAA dataset.

```{r}
interest <- c("EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", "PROPDMGEXP")
storm.short <- storm[ , interest]
```

The `EVTYPE` variable at the `storm` dataframe is very untidy and has 985 levels. Meanwhile, the National Weather Service Storm Data Documentation specifies 48 permitted events. First of all, let's reduce a count of levels into 48 by the script [cleaning_storm_data.R](https://github.com/art2art/reproducible_research_2/blob/master/cleanStorm.R). The script contains `cleanStorm` function which tidies variables of interest - `EVTYPE` and `PROPDMGEXP`.

```{r}
source("cleanStorm.R")
storm.short <- cleanStorm(storm.short)
```

Add new necessary variable `ECONOMICDAMAGE` for estimating economic damage.

```{r}
storm.short$ECONOMICDAMAGE <- storm.short$PROPDMGEXP * storm.short$PROPDMG
```

Finally, create a new dataset adapted for futher data analysis. The new dataset contains a total number of injured people, a total number of died people and total estimate of damage in dollars per severe weather events.

```{r}
loss <- ddply(storm.short,
              ~EVTYPE,
              summarise,
              economicdamage = sum(ECONOMICDAMAGE, na.rm = TRUE),
              fatalities     = sum(FATALITIES, na.rm = TRUE),
              injures        = sum(INJURIES, na.rm = TRUE))
```

### Results

Top 10 of harmful severe weather events with respect to population health.

```{r}
top10.injures <- arrange(df = loss, desc(injures))[1:10, ]
format(top10.injures, scientific = F)
```

Make a barplot of top 10 harmful severe weather events with respect to population health.

```{r}
p <- ggplot(top10.injures, aes(x = EVTYPE, y = injures))
p <- p + geom_bar(stat = "identity")
p <- p + xlab("Event type") + ylab("Number of injures")
p <- p + ggtitle("Top 10 harmful severe weather events")
p <- p + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
```

Top 10 of the most deadly severe weather events.

```{r}
top10.fatalities <- arrange(df = loss, desc(fatalities))[1:10, ]
format(top10.fatalities, scientific = F)
```

Make a barplot of top 10 the most deadly events.

```{r}
p <- ggplot(top10.fatalities, aes(x = EVTYPE, y = fatalities))
p <- p + geom_bar(stat = "identity")
p <- p + xlab("Event type") + ylab("Number of deaths")
p <- p + ggtitle("Top 10 most deadly events")
p <- p + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
```

Top 10 of events having the greatest economic consequences.

```{r}
top10.economic <- arrange(df = loss, desc(economicdamage))[1:10, ]
format(top10.economic, scientific = F)
```

Make a barplot of top 10 events of greatest economic consequences.

```{r}
p <- ggplot(top10.economic, aes(x = EVTYPE, y = economicdamage))
p <- p + geom_bar(stat = "identity")
p <- p + xlab("Event type") + ylab("The property damage (in dollar amounts)")
p <- p + ggtitle("Events have the greatest economic consequences")
p <- p + theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
```

## Conclusion

Tornadoes together with thunderstorm winds, floods and excessive heat were the most harmful severe weather events, which caused over 90000 injuries only in the last 60 years. Most deadly events were caused also by tornadoes with about 5600 deaths in the past 60 years. Floods had the greatest economic consequences with over 150 billion dollars in property damages. Hurricanes, storm surges, tornadoes caused the greates economic consequences as well as. 




